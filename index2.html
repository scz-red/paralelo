<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora al Paralelo — LUPO</title>

  <!-- 1) Preload del logo para mejor LCP -->
  <link rel="preload" as="image" href="/icons/banner.png" />

  <!-- 2) PWA iOS + iconos -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/icons/maskable-512.png" />

  <!-- 3) CSP básica (idealmente en cabeceras del servidor) -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; connect-src 'self' https://api.lupo.lat https://open.er-api.com https://api.coingecko.com https://p2p.binance.com; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';" />

  <style>
    :root { --bg:#f7f6f4; --fg:#232323; --muted:#6b7280; --brand:#8D6E63; --panel:#ffffff; --card:#ffffff; --border:#e6e6e6; }
    html, body {height:100%;}
    body {margin:0; background:var(--bg); color:var(--fg); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";}
    .wrap {max-width:960px; margin:0 auto; padding:24px 16px 72px;}

    header {display:grid; grid-template-columns:auto 1fr; gap:12px; align-items:center; margin-bottom:18px;}
    header img {height:48px; width:auto; display:block;}
    header .sub {color:var(--muted); font-size:14px;}

    .panel {background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 6px 14px rgba(0,0,0,.05);}  
    .panel + .panel {margin-top:14px;}

    .row {display:flex; gap:12px; flex-wrap:wrap; align-items:stretch;}
    .card {flex:1 1 300px; background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;}

    label {display:block; font-size:13px; color:#4b5563; margin-bottom:6px;}
    input[type="number"]{width:100%; background:#fff; color:var(--fg); border:1px solid #dcdcdc; border-radius:12px; padding:12px 14px; font-size:16px; outline:none;}
    input[type="number"]:focus{border-color:var(--brand);} 

    .hint {display:flex; gap:10px; align-items:center; color:#6b7280; font-size:12px;}
    .hint .dot {width:8px; height:8px; border-radius:50%; background:#22c55e;}

    h2 {font-size:18px; margin:0 0 8px;}

    .list {display:grid; grid-template-columns:repeat(auto-fill,minmax(210px,1fr)); gap:10px;}
    .item {display:flex; justify-content:space-between; align-items:center; background:#fff; border:1px solid #e9e9e9; border-radius:12px; padding:10px 12px;}
    .item .name {color:#374151; font-size:14px;}
    .item .val {font-weight:600; font-variant-numeric: tabular-nums; color:#111827;}

    .copy {border:1px solid #d0d0d0; background:#fafafa; color:#1f2937; border-radius:10px; padding:6px 10px; font-size:12px; cursor:pointer;}
    .copy:active{transform:scale(.98);}  

    .muted {color:#6b7280; font-size:12px;}
    .success {color:#16a34a;}
    .error {color:#dc2626;}
    .time {font-size:12px; color:#6b7280;}

    footer {position:fixed; left:0; right:0; bottom:0; background:var(--bg); border-top:1px solid var(--border); padding:10px 16px;}
    .footer-row {display:flex; gap:10px; align-items:center; justify-content:space-between; max-width:960px; margin:0 auto;}
    .cta {background:var(--brand); color:#ffffff; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="/icons/banner.png" alt="LUPO" width="188" height="48" />
      <div class="sub">Calculadora al Paralelo · Convierte BOB a FIAT y Cripto en tiempo real</div>
    </header>

    <section class="panel" aria-live="polite">
      <div class="row">
        <div class="card" style="min-width:260px">
          <label for="amount">Monto en Bolivianos (BOB)</label>
          <input id="amount" name="amount" inputmode="decimal" type="number" step="0.01" min="0" placeholder="1000" aria-describedby="inputHelp" />
          <div id="inputHelp" class="hint" style="margin-top:8px">
            <span class="dot" id="liveDot"></span>
            <span id="statusText">Listo</span>
            <span class="time" id="lastUpdated" aria-live="polite"></span>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" aria-busy="false" aria-live="polite">
      <h2>FIAT</h2>
      <div id="fiatList" class="list" role="list"></div>
      <div id="fiatNote" class="muted" style="margin-top:8px"></div>
    </section>

    <section class="panel" aria-busy="false" aria-live="polite">
      <h2>Cripto</h2>
      <div id="cryptoList" class="list" role="list"></div>
    </section>
  </div>

  <footer>
    <div class="footer-row">
      <div class="muted">Consejo: toca cualquier valor para copiarlo</div>
      <button id="cta" class="cta">Enviar con LUPO</button>
    </div>
  </footer>

  <script>
    // ======= CONFIG =======
    const API_BASE = "https://api.lupo.lat"; // Ajusta si usas otro dominio
    const INPUT = document.getElementById('amount');
    const fiatList = document.getElementById('fiatList');
    const cryptoList = document.getElementById('cryptoList');
    const statusText = document.getElementById('statusText');
    const liveDot = document.getElementById('liveDot');
    const lastUpdated = document.getElementById('lastUpdated');
    const fiatNote = document.getElementById('fiatNote');
    const CTA = document.getElementById('cta');

    // ======= Persistencia del monto (localStorage) + parámetro URL =======
    function getMontoInicial(){
      const url = new URL(window.location.href);
      const qMonto = url.searchParams.get('monto');
      if (qMonto && !isNaN(+qMonto)) return +qMonto;
      const saved = localStorage.getItem('monto_bob');
      if (saved && !isNaN(+saved)) return +saved;
      return 1000;
    }

    function saveMonto(v){ localStorage.setItem('monto_bob', String(v)); }

    // ======= Formateo robusto =======
    const fmt = new Intl.NumberFormat('es-BO', { maximumFractionDigits: 2, minimumFractionDigits: 0 });
    function formatCurrency(val, code){
      let opts;
      if(code === 'COP') opts = { style:'currency', currency:'COP', maximumFractionDigits:0 };
      else if(code === 'BOB') opts = { style:'currency', currency:'BOB', maximumFractionDigits:2 };
      else opts = { style:'currency', currency:code, maximumFractionDigits:2 };
      return new Intl.NumberFormat('es-BO', opts).format(val);
    }

    // ======= AbortController para evitar respuestas cruzadas =======
    let currentController = null;

    async function fetchAll(monto){
      if(currentController) currentController.abort();
      currentController = new AbortController();
      const { signal } = currentController;

      statusText.textContent = 'Actualizando…';
      document.querySelectorAll('section[aria-busy]')
        .forEach(s => s.setAttribute('aria-busy','true'));

      try {
        const url = `${API_BASE}/convertir_bob?monto_bob=${encodeURIComponent(monto)}`;
        const res = await fetch(url, { signal });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();

        renderFiat(data.conversiones_fiat);
        renderCrypto(data.conversiones_cripto);

        // Guardar último OK para modo offline
        localStorage.setItem('ultimo_ok_json', JSON.stringify({ t:Date.now(), monto, data }));
        setLive(true, 'Actualizado');
      } catch(err){
        if(err.name === 'AbortError') return; // ignorar
        // Fallback offline con el último OK
        const last = localStorage.getItem('ultimo_ok_json');
        if(last){
          try{
            const { data } = JSON.parse(last);
            renderFiat(data.conversiones_fiat);
            renderCrypto(data.conversiones_cripto);
            setLive(false, 'Modo offline (mostrando último cálculo)');
          }catch(e){ showError('Sin conexión y sin datos previos'); }
        }else{
          showError('No se pudo actualizar');
        }
      } finally {
        document.querySelectorAll('section[aria-busy]')
          .forEach(s => s.setAttribute('aria-busy','false'));
        lastUpdated.textContent = '· ' + new Date().toLocaleTimeString('es-BO', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
      }
    }

    function setLive(ok, msg){
      statusText.textContent = msg;
      liveDot.style.background = ok ? '#22c55e' : '#ef4444';
    }
    function showError(msg){ setLive(false, msg); }

    // ======= Pintado de listas + copiar =======
    function renderFiat(map){
      fiatList.innerHTML = '';
      fiatNote.textContent = 'Sin descuentos aplicados (USD y EUR se muestran tal cual).';
      Object.entries(map).forEach(([name, val])=>{
        // detectar código por nombre simple
        const code = guessCodeFromName(name);
        const text = typeof val === 'number' ? formatCurrency(val, code) : val;
        const btn = `<button class="copy" data-copy="${typeof val==='number'? val: ''}">Copiar</button>`;
        fiatList.insertAdjacentHTML('beforeend', `<div class="item" role="listitem"><span class="name">${name}</span><span class="val">${text}</span>${btn}</div>`);
      });
    }

    function renderCrypto(map){
      cryptoList.innerHTML = '';
      Object.entries(map).forEach(([code, val])=>{
        const text = typeof val === 'number' ? new Intl.NumberFormat('es-BO', {maximumFractionDigits:6}).format(val) + ' ' + code : val;
        const btn = `<button class="copy" data-copy="${typeof val==='number'? val: ''}">Copiar</button>`;
        cryptoList.insertAdjacentHTML('beforeend', `<div class="item" role="listitem"><span class="name">${code}</span><span class="val">${text}</span>${btn}</div>`);
      });
    }

    function guessCodeFromName(name){
      // nombres usados en tu API
      if(name.includes('Dólar')) return 'USD';
      if(name.includes('Euro')) return 'EUR';
      if(name.includes('colombiano')) return 'COP';
      if(name.includes('argentino')) return 'ARS';
      if(name.includes('chileno')) return 'CLP';
      if(name.includes('brasileño')) return 'BRL';
      if(name.includes('peruano')) return 'PEN';
      if(name.includes('paraguayo')) return 'PYG';
      if(name.includes('mexicano')) return 'MXN';
      if(name.includes('chino')) return 'CNY';
      return 'USD';
    }

    // Copiar al portapapeles
    document.addEventListener('click', (e)=>{
      const el = e.target.closest('[data-copy]');
      if(!el) return;
      const raw = el.getAttribute('data-copy');
      if(!raw) return;
      navigator.clipboard.writeText(raw).then(()=>{
        el.textContent = 'Copiado';
        setTimeout(()=> el.textContent = 'Copiar', 900);
      });
    });

    // CTA WhatsApp (ajusta tu número)
    CTA.addEventListener('click', ()=>{
      const monto = INPUT.value || 0;
      const url = `https://wa.me/59171077231?text=Quiero%20enviar%20${encodeURIComponent(monto)}%20BOB%20con%20LUPO`;
      window.open(url, '_blank');
    });

    // ======= Debounce input + auto-refresh silencioso =======
    let t = null;
    INPUT.addEventListener('input', ()=>{
      const v = Number(INPUT.value.replace(',', '.'));
      if(!isFinite(v)) return;
      // tope a 2 decimales al escribir
      if(String(v).includes('.')){
        const [a,b=''] = String(v).split('.');
        INPUT.value = a + '.' + b.slice(0,2);
      }
      saveMonto(INPUT.value);
      if(t) clearTimeout(t);
      t = setTimeout(()=> fetchAll(Number(INPUT.value||0)), 350);
    });

    // Auto-refresh cada 60s
    setInterval(()=>{
      const v = Number(INPUT.value||0);
      if(v>0) fetchAll(v);
    }, 60000);

    // ======= Inicio =======
    const startMonto = getMontoInicial();
    INPUT.value = String(startMonto);
    fetchAll(startMonto);

    // Registrar SW si existe
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
    }
  </script>
</body>
</html>
