<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://api.lupo.lat" crossorigin>
  <link rel="dns-prefetch" href="//currencyfreaks.com">

  <!-- SEO Básico -->
  <title>Calculadora al Paralelo - Convierte BOB a monedas fiat y cripto</title>
  <meta name="description" content="Convierte Bolivianos (BOB) a monedas fiat y cripto en tiempo real. Tasas de referencia USD y EUR. Calculadora al paralelo.">
  <meta name="author" content="Paralelo.scz.red">

  <!-- Para Google / motores de búsqueda -->
  <link rel="canonical" href="https://paralelo.scz.red/">

  <!-- Open Graph (para Facebook, WhatsApp, etc.) -->
  <meta property="og:locale" content="es_LA">
  <meta property="og:title" content="Calculadora al Paralelo - Convierte BOB a monedas fiat y cripto">
  <meta property="og:description" content="Convierte Bolivianos a monedas fiat y criptomonedas con precios en tiempo real.">
  <meta property="og:image" content="https://paralelo.scz.red/icons/banner.png">
  <meta property="og:url" content="https://paralelo.scz.red/">
  <meta property="og:type" content="website">

  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Calculadora al Paralelo - Convierte BOB a monedas fiat y cripto">
  <meta name="twitter:description" content="Convierte Bolivianos a monedas fiat y criptomonedas en tiempo real.">
  <meta name="twitter:image" content="https://paralelo.scz.red/icons/banner.png">


  <!-- Iconos / Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png" />
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png" />

  <!-- PWA -->
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="./manifest.json" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root {
      /* Paleta minimalista clara */
      --accent: #3b82f6;
      --accent-dark: #1e40af;
      --background: #f7f7f8;
      --card: #ffffff;
      --text: #1f2937;
      --text-light: #6b7280;
      --border: rgba(0, 0, 0, 0.08);
      --shadow: 0 8px 24px rgba(2, 6, 23, 0.06);
      --glass: rgba(59, 130, 246, 0.06);
      color-scheme: light; /* fuerza modo claro */
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 1200px at 10% -10%, var(--glass), transparent 60%), var(--background);
      color: var(--text);
    }
    .visually-hidden { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0 0 0 0); white-space: nowrap; border: 0; }

    .app-container { max-width: 920px; margin: 24px auto 80px; padding: 0 16px; }
    .header {
      display: flex; align-items: center; gap: 14px; margin-bottom: 18px;
      padding: 14px 16px; background: var(--card);
      border-radius: 16px; box-shadow: var(--shadow); border: 1px solid var(--border);
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-logo { height: 40px; width: auto; display: block; }
    .header p { color: var(--text-light); font-size: .95rem; }

    .input-container {
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(180deg, rgba(247,247,248,1) 0%, rgba(247,247,248,.8) 60%, rgba(247,247,248,0) 100%);
      padding: 12px 0 4px; margin-bottom: 8px;
    }
    .panel {
      background: var(--card); border-radius: 16px; box-shadow: var(--shadow); border: 1px solid var(--border);
      padding: 16px;
    }

    .flags { display: flex; align-items: center; gap: 8px; }
    .flags img { width: 20px; height: 14px; object-fit: cover; border-radius: 2px; border: 1px solid var(--border); }

    .input-group { position: relative; margin-bottom: 16px; }
    .input-group label { display: block; font-size: 0.84rem; font-weight: 600; margin-bottom: 8px; color: var(--text-light); }
    .input-group input {
      width: 100%; padding: 16px 52px 16px 16px; font-size: 1.05rem; border-radius: 14px;
      border: 1px solid var(--border); background: #fff; color: var(--text); font-weight: 600; transition: box-shadow .2s, transform .15s;
    }
    .input-group input:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(59,130,246,0.18);
      transform: translateY(-1px);
    }
    .input-help { margin-top: 6px; font-size: .78rem; color: var(--text-light); }
    .input-error { display: none; margin-top: 6px; font-size: .82rem; color: #b91c1c; font-weight: 600; }
    .input-group.invalid input { border-color: #ef4444; box-shadow: 0 0 0 4px rgba(239,68,68,0.18); }
    .input-group.invalid .input-error { display: block; }

    .currency-selector {
      position: absolute; right: 12px; top: 34px; display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; background: #f1f5f9; border: 1px solid var(--border); border-radius: 12px; color: #334155; font-weight: 700;
    }
    .currency-selector img { width: 20px; height: 14px; object-fit: cover; border-radius: 4px; border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.16); }

    /* Tasas */
    .tasas-referencia { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; }
    .tasa-item { background: var(--card); border-radius: 14px; padding: 12px; text-align: center; border: 1px solid var(--border); box-shadow: var(--shadow); }
    .tasa-monedas { font-size: .86rem; color: var(--text-light); }
    .tasa-valor { font-size: 1.2rem; font-weight: 800; color: var(--accent-dark); }

    .results {
      margin-top: 16px; background: rgba(255,255,255,.66);
      border-radius: 24px 24px 0 0;
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      border: 1px solid var(--border);
    }

    .section-title { display: flex; align-items: center; gap: 8px; padding: 12px 16px; color: var(--text-light); font-weight: 700; text-transform: uppercase; letter-spacing: .04em; }
    .section-title i { opacity: .7; }

    .currency-list { list-style: none; padding: 8px 8px 6px; display: grid; grid-template-columns: 1fr; gap: 8px; }
    @media (min-width: 540px) { .currency-list { grid-template-columns: 1fr 1fr; } }
    @media (min-width: 860px) { .currency-list { grid-template-columns: 1fr 1fr 1fr; } }

    .currency-item { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 10px; padding: 10px 10px; border: 1px solid var(--border); border-radius: 14px; background: var(--card); box-shadow: var(--shadow); }
    .currency-icon img { width: 34px; height: 34px; border-radius: 8px; border: 1px solid var(--border); object-fit: cover; display: block; }
    .currency-name { font-weight: 700; color: var(--text); }
    .currency-code { font-size: .82rem; color: var(--text-light); }
    .currency-value { font-weight: 800; font-size: 1.02rem; color: var(--accent-dark); }

    .loading { display: flex; align-items: center; gap: 8px; color: var(--text-light); font-weight: 600; padding: 12px 16px; }
  </style>
</head>

<body>
<noscript>Esta calculadora requiere JavaScript para funcionar.</noscript>
<div class="app-container">
  <div class="header" role="banner">
    <h1 class="visually-hidden">Calculadora al paralelo BOB → fiat/cripto</h1>
    <div class="brand" aria-label="Paralelo">
      <img src="./icons/banner.png" alt="Paralelo" class="brand-logo" decoding="async">
      <span class="visually-hidden">Paralelo Bs</span>
    </div>
    <p>Convierte Bs. a diferente tipo de cambio Paralelo</p>
  </div>

  <main role="main">
    <div class="input-container">
      <div class="input-group" id="group-monto">
        <label for="monto">Monto a convertir</label>
        <input type="text" id="monto" value="1000" inputmode="decimal" placeholder="Ingresa monto en BOB" aria-describedby="montoHelp montoError" aria-invalid="false" />
        <span class="currency-selector" aria-hidden="true">
          <img src="paralelo/bandera-bolivia.png" alt="Bolivia">
          <strong>BOB</strong>
        </span>
        <div id="montoHelp" class="input-help">Monto en bolivianos .</div>
        <div id="montoError" class="input-error">Ingrese un monto válido .</div>
      </div>

      <div class="tasas-referencia" aria-label="Tasas de referencia">
        <div class="tasa-item" aria-live="polite" role="status">
          <div class="tasa-monedas">USD/BOB</div>
          <div class="tasa-valor" id="tasa-usd">--</div>
        </div>
        <div class="tasa-item" aria-live="polite" role="status">
          <div class="tasa-monedas">EUR/BOB</div>
          <div class="tasa-valor" id="tasa-eur">--</div>
        </div>
      </div>
    </div>

    <div class="results" aria-live="polite" aria-atomic="true">
      <div class="section-title">
        <i class="fas fa-money-bill-wave"></i>
        <span>Monedas tradicionales</span>
      </div>
      <ul class="currency-list" id="fiat-list"></ul>

      <div class="section-title">
        <i class="fas fa-coins"></i>
        <span>Criptomonedas</span>
      </div>
      <ul class="currency-list" id="crypto-list"></ul>

      <div id="loader-global" style="display:none;" role="status" aria-live="polite">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i>
          Calculando tasas...
        </div>
      </div>
    </div>
  </main>

  <!-- Registro del Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
      });
    }
  </script>

  <script>
    // ====== Configuración ======
    const fiatCurrencies = {
      "Dólar estadounidense": { code: "USD", icon: "https://currencyfreaks.com/photos/flags/usd.png" },
      "Euro": { code: "EUR", icon: "https://currencyfreaks.com/photos/flags/eur.png" },
      "Peso colombiano": { code: "COP", icon: "https://currencyfreaks.com/photos/flags/cop.png" },
      "Peso argentino": { code: "ARS", icon: "https://currencyfreaks.com/photos/flags/ars.png" },
      "Peso chileno": { code: "CLP", icon: "https://currencyfreaks.com/photos/flags/clp.png" },
      "Real brasileño": { code: "BRL", icon: "https://currencyfreaks.com/photos/flags/brl.png" },
      "Sol peruano": { code: "PEN", icon: "https://currencyfreaks.com/photos/flags/pen.png" },
      "Yuan chino": { code: "CNY", icon: "https://currencyfreaks.com/photos/flags/cny.png" },
      "Guaraní paraguayo": { code: "PYG", icon: "https://currencyfreaks.com/photos/flags/pyg.png" },
      "Peso mexicano": { code: "MXN", icon: "https://currencyfreaks.com/photos/flags/mxn.png" }
    };

    const cryptoCurrencies = [
      { name: 'Tether (USDT)', code: 'USDT', icon: 'https://paralelo.scz.red/paralelo/1.png' },
      { name: 'Bitcoin', code: 'BTC', icon: 'https://paralelo.scz.red/paralelo/2.png' },
      { name: 'Ethereum', code: 'ETH', icon: 'https://paralelo.scz.red/paralelo/3.png' },
      { name: 'USD Coin', code: 'USDC', icon: 'https://paralelo.scz.red/paralelo/4.png' },
      { name: 'Dogecoin', code: 'DOGE', icon: 'https://paralelo.scz.red/paralelo/5.png' },
      { name: 'Solana', code: 'SOL', icon: 'https://paralelo.scz.red/paralelo/6.png' },
      { name: 'Pepe', code: 'PEPE', icon: 'https://paralelo.scz.red/paralelo/7.png' },
      { name: 'Trump', code: 'TRUMP', icon: 'https://paralelo.scz.red/paralelo/8.png' }
    ];

    const montoInput = document.getElementById('monto');
    const groupMonto  = document.getElementById('group-monto');
    const fiatList = document.getElementById('fiat-list');
    const cryptoList = document.getElementById('crypto-list');
    const loaderGlobal = document.getElementById('loader-global');
    const tasaUSD = document.getElementById('tasa-usd');
    const tasaEUR = document.getElementById('tasa-eur');

    // Cache en memoria (por monto)
    const memCache = {};
    const store = {
      get: (k) => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
      set: (k,v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} }
    };

    function createEl(tag, opts = {}, children = []) {
      const el = document.createElement(tag);
      for (const [k, v] of Object.entries(opts)) {
        if (k === 'text') el.textContent = v;
        else if (k === 'class') el.className = v;
        else if (k === 'html') el.innerHTML = v;
        else el.setAttribute(k, v);
      }
      if (Array.isArray(children) && children.length) el.append(...children);
      return el;
    }

    function formatNumber(v) {
      const num = typeof v === 'number' ? v : Number(v);
      if (!isFinite(num)) return '--';
      return new Intl.NumberFormat('es-BO', { maximumFractionDigits: 2 }).format(num);
    }

    function clearResults() {
      fiatList.replaceChildren();
      cryptoList.replaceChildren();
    }

    function showGlobalLoader(show = true) {
      loaderGlobal.style.display = show ? 'block' : 'none';
      if (show) { clearResults(); }
    }

    function validarMontoStr(str) {
      if (!str) return false;
      const clean = str.replace(/[^\d.,]/g, '');
      const points = (clean.match(/[.,]/g) || []).length;
      if (points > 1) return false;
      const normalized = clean.replace(',', '.');
      const n = Number(normalized);
      return isFinite(n) && n > 0;
    }

    function setMontoValidity(isValid) {
      groupMonto.classList.toggle('invalid', !isValid);
      document.getElementById('montoError').style.display = isValid ? 'none' : 'block';
    }

    async function actualizarTasasUI() {
      try {
        const res = await fetch('https://api.lupo.lat/tasas_referencia');
        if (!res.ok) throw new Error('No se pudo obtener tasas');
        const json = await res.json();
        const usd = json?.tasas?.USD_BOB ?? json?.USD_BOB ?? null;
        const eur = json?.tasas?.EUR_BOB ?? json?.EUR_BOB ?? null;
        tasaUSD.textContent = usd ? formatNumber(usd) : '--';
        tasaEUR.textContent = eur ? formatNumber(eur) : '--';
      } catch {
        tasaUSD.textContent = 'Error'; tasaEUR.textContent = 'Error';
      }
    }

    async function calcular(force=false) {
      const raw = montoInput.value;
      const isValid = validarMontoStr(raw);
      setMontoValidity(isValid);
      if (!isValid) { clearResults(); actualizarTasasUI(); return; }

      const clean = raw.replace(/[^\d.,]/g, '').replace(',', '.');
      const monto = Number(clean);
      const storeKey = `conv_${monto}`;

      // cache localStorage (1 min)
      const cached = store.get(storeKey);
      if (!force && cached) {
        renderCurrencyList(fiatList, cached.fiat, fiatCurrencies, false);
        renderCurrencyList(cryptoList, cached.crypto, cryptoCurrencies, true);
        actualizarTasasUI();
        memCache[monto] = { ...cached, t: Date.now() };
        return;
      }

      if (offline()) {
        clearResults(); showGlobalLoader(false);
        tasaUSD.textContent = 'Sin conexión'; tasaEUR.textContent = 'Sin conexión';
        fiatList.appendChild(createEl('div', { class: 'loading', text: 'Sin conexión' }));
        return;
      }

      showGlobalLoader(true);
      try {
        const res = await fetch(`https://api.lupo.lat/convertir_bob?monto_bob=${encodeURIComponent(monto)}`);
        if (!res.ok) throw new Error(`Error API: ${res.status}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        const fiat = data.conversiones_fiat || {}; const crypto = data.conversiones_cripto || {};
        showGlobalLoader(false);
        renderCurrencyList(fiatList, fiat, fiatCurrencies, false);
        renderCurrencyList(cryptoList, crypto, cryptoCurrencies, true);
        actualizarTasasUI();

        const payload = { fiat, crypto };
        memCache[monto] = { ...payload, t: Date.now() };
        store.set(storeKey, payload);
      } catch (e) {
        showGlobalLoader(false);
        clearResults();
        fiatList.appendChild(createEl('div', { class: 'loading', text: 'Error al calcular' }));
        tasaUSD.textContent = 'Error';
        tasaEUR.textContent = 'Error';
      }
    }

    function offline() { return !navigator.onLine; }

    function renderCurrencyList(listElement, data, dictionary, isCrypto = false) {
      listElement.replaceChildren();

      if (!data || Object.keys(data).length === 0) {
        const empty = createEl('div', { class: 'loading' }, [
          createEl('i', { class: 'fas fa-circle-info' }),
          createEl('span', { text: 'Sin datos disponibles' })
        ]);
        listElement.appendChild(empty);
        return;
      }

      if (Array.isArray(data)) {
        data.forEach(item => {
          const [name, code, value, iconUrl] = item;
          const li = createEl('li', { class: 'currency-item', role: 'listitem' });
          const icon = createEl('div', { class: 'currency-icon' }, [
            Object.assign(new Image(), { src: iconUrl, alt: name })
          ]);
          const details = createEl('div', { class: 'currency-details' }, [
            createEl('div', { class: 'currency-name', text: name }),
            createEl('div', { class: 'currency-code', text: code })
          ]);
          const right = createEl('div', { class: 'currency-right' }, [
            createEl('div', { class: 'currency-value', text: formatNumber(value) })
          ]);
          li.append(icon, details, right);
          listElement.appendChild(li);
        });
        return;
      }

      for (const [name, value] of Object.entries(data)) {
        const info = dictionary[name] || { code: name.slice(0, 3).toUpperCase(), icon: `https://via.placeholder.com/40/3b82f6/ffffff?text=${name.slice(0,2)}` };

        const li = createEl('li', { class: 'currency-item', role: 'listitem' });
        const icon = createEl('div', { class: 'currency-icon' }, [
          Object.assign(new Image(), { src: info.icon, alt: name || info.code || '', referrerPolicy: 'no-referrer' })
        ]);

        const details = createEl('div', { class: 'currency-details' }, [
          createEl('div', { class: 'currency-name', text: name }),
          createEl('div', { class: 'currency-code', text: info.code })
        ]);

        const right = createEl('div', { class: 'currency-right' }, [
          createEl('div', { class: 'currency-value', text: formatNumber(value) })
        ]);

        li.append(icon, details, right);
        listElement.appendChild(li);
      }
    }

    function preloadCryptoImages() {
      cryptoCurrencies.forEach(crypto => { const img = new Image(); img.src = crypto.icon; });
    }

    // Eventos
    let debounce;
    montoInput.addEventListener('input', () => {
      clearTimeout(debounce);
      debounce = setTimeout(() => calcular(), 500);
    });
    // Enter = calcular ahora
    montoInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); calcular(true); }});
    // Validación de caracteres
    montoInput.addEventListener('keypress', (e) => {
      const char = String.fromCharCode(e.which);
      if (!/[0-9.,]/.test(char)) e.preventDefault();
      if ((char === '.' || char === ',') && (montoInput.value.includes('.') || montoInput.value.includes(','))) e.preventDefault();
    });

    montoInput.addEventListener('paste', (e) => {
      const value = (e.clipboardData || window.clipboardData).getData('text');
      if (!/^[0-9]+([.,][0-9]{0,2})?$/.test(value.replace(/\s/g,''))) e.preventDefault();
    });

    window.addEventListener('online', () => { calcular(true); actualizarTasasUI(); });
    window.addEventListener('offline', () => {
      tasaUSD.textContent = 'Sin conexión';
      tasaEUR.textContent = 'Sin conexión';
    });

    document.addEventListener('DOMContentLoaded', () => {
      preloadCryptoImages();
      montoInput.focus();
      calcular(true);
      actualizarTasasUI();
      setInterval(() => actualizarTasasUI(), 60_000);
    });
  </script>
</div>
</body>
</html>
